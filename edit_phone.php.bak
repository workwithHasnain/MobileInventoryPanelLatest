<?php
require_once 'auth.php';
require_once 'phone_data.php';
require_once 'brand_data.php';

// Require login for this page
requireLogin();

$errors = [];
$success = false;
$phone = null;

// Get phone ID from URL parameter
$id = isset($_GET['id']) ? (int)$_GET['id'] : -1;

// Get phone data
$phones = getAllPhones();

// Check if phone exists
if ($id < 0 || !isset($phones[$id])) {
    $_SESSION['success_message'] = 'Phone not found!';
    header('Location: dashboard.php');
    exit();
}

$phone = $phones[$id];

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Validate required fields
    $name = isset($_POST['name']) ? trim($_POST['name']) : '';
    if (empty($name)) {
        $errors['name'] = 'Phone name is required';
    }

    $brand = isset($_POST['brand']) ? trim($_POST['brand']) : '';
    if (empty($brand)) {
        $errors['brand'] = 'Brand is required';
    }

    $year = isset($_POST['year']) ? trim($_POST['year']) : '';
    if (empty($year) || !is_numeric($year) || $year < 2000 || $year > date('Y') + 2) {
        $errors['year'] = 'Please enter a valid year between 2000 and ' . (date('Y') + 2);
    }

    $availability = isset($_POST['availability']) ? trim($_POST['availability']) : '';
    if (empty($availability)) {
        $errors['availability'] = 'Availability status is required';
    }

    $price = isset($_POST['price']) ? trim($_POST['price']) : '';
    if (empty($price) || !is_numeric($price) || $price <= 0) {
        $errors['price'] = 'Please enter a valid price greater than 0';
    }

    // Handle multiple image uploads (up to 5)
    $image_paths = isset($phone['images']) ? $phone['images'] : []; // Keep existing images
    $image_path = $phone['image']; // Keep existing main image if no new one uploaded
    
    if (isset($_FILES['images']) && is_array($_FILES['images']['name'])) {
        $allowed_types = ['image/jpeg', 'image/png', 'image/gif'];
        $max_size = 5 * 1024 * 1024; // 5MB
        $max_images = 5;
        
        // Create uploads directory if it doesn't exist
        if (!file_exists('uploads')) {
            mkdir('uploads', 0777, true);
        }
        
        // Only replace if new images are uploaded
        $new_images_uploaded = false;
        for ($i = 0; $i < min(count($_FILES['images']['name']), $max_images); $i++) {
            if (!empty($_FILES['images']['name'][$i])) {
                $new_images_uploaded = true;
                break;
            }
        }
        
        if ($new_images_uploaded) {
            // Delete old images if new ones are being uploaded
            if (!empty($image_paths)) {
                foreach ($image_paths as $old_image) {
                    if (file_exists($old_image)) {
                        unlink($old_image);
                    }
                }
            }
            
            $image_paths = []; // Reset image paths array
            
            for ($i = 0; $i < min(count($_FILES['images']['name']), $max_images); $i++) {
                if (!empty($_FILES['images']['name'][$i]) && $_FILES['images']['error'][$i] === UPLOAD_ERR_OK) {
                    $file_type = $_FILES['images']['type'][$i];
                    $file_size = $_FILES['images']['size'][$i];
                    
                    // Validate file type
                    if (!in_array($file_type, $allowed_types)) {
                        $errors['image' . ($i + 1)] = 'Only JPG, PNG, and GIF images are allowed for image ' . ($i + 1);
                    }
                    
                    // Validate file size
                    if ($file_size > $max_size) {
                        $errors['image' . ($i + 1)] = 'Image ' . ($i + 1) . ' size should not exceed 5MB';
                    }
                    
                    // If no errors, process the upload
                    if (!isset($errors['image' . ($i + 1)])) {
                        // Generate unique filename
                        $file_extension = pathinfo($_FILES['images']['name'][$i], PATHINFO_EXTENSION);
                        $filename = 'phone_' . time() . '_' . uniqid() . '_' . ($i + 1) . '.' . $file_extension;
                        $upload_path = 'uploads/' . $filename;
                        
                        if (move_uploaded_file($_FILES['images']['tmp_name'][$i], $upload_path)) {
                            $image_paths[] = $upload_path;
                        } else {
                            $errors['image' . ($i + 1)] = 'Failed to upload image ' . ($i + 1) . '. Please try again.';
                        }
                    }
                }
            }
            
            // Set main image path (first uploaded image)
            $image_path = !empty($image_paths) ? $image_paths[0] : '';
        }
    }

    // If no errors, update the phone data
    if (empty($errors)) {
        $updated_phone = [
            // Launch
            'release_date' => $_POST['release_date'] ?? $phone['release_date'] ?? '',
            
            // General
            'name' => $name,
            'brand' => $brand,
            'year' => $year,
            'availability' => $availability,
            'price' => $price,
            'image' => $image_path,
            'images' => $image_paths,
            
            // Network
            '2g' => $_POST['2g'] ?? $phone['2g'] ?? [],
            '3g' => $_POST['3g'] ?? $phone['3g'] ?? [],
            '4g' => $_POST['4g'] ?? $phone['4g'] ?? [],
            '5g' => $_POST['5g'] ?? $phone['5g'] ?? [],
            
            // SIM
            'dual_sim' => isset($_POST['dual_sim']),
            'esim' => isset($_POST['esim']),
            'sim_size' => $_POST['sim_size'] ?? $phone['sim_size'] ?? [],
            
            // Body
            'dimensions' => $_POST['dimensions'] ?? $phone['dimensions'] ?? '',
            'form_factor' => $_POST['form_factor'] ?? $phone['form_factor'] ?? '',
            'keyboard' => $_POST['keyboard'] ?? $phone['keyboard'] ?? '',
            'height' => $_POST['height'] ?? $phone['height'] ?? '',
            'width' => $_POST['width'] ?? $phone['width'] ?? '',
            'thickness' => $_POST['thickness'] ?? $phone['thickness'] ?? '',
            'weight' => $_POST['weight'] ?? $phone['weight'] ?? '',
            'ip_certificate' => $_POST['ip_certificate'] ?? $phone['ip_certificate'] ?? [],
            'color' => $_POST['color'] ?? $phone['color'] ?? '',
            'back_material' => $_POST['back_material'] ?? $phone['back_material'] ?? '',
            'frame_material' => $_POST['frame_material'] ?? $phone['frame_material'] ?? '',
            
            // Platform
            'os' => $_POST['os'] ?? $phone['os'] ?? '',
            'os_version' => $_POST['os_version'] ?? $phone['os_version'] ?? '',
            'chipset' => $_POST['chipset'] ?? $phone['chipset'] ?? '',
            'cpu_cores' => $_POST['cpu_cores'] ?? $phone['cpu_cores'] ?? '',
            
            // Memory
            'ram' => $_POST['ram'] ?? $phone['ram'] ?? '',
            'storage' => $_POST['storage'] ?? $phone['storage'] ?? '',
            'card_slot' => $_POST['card_slot'] ?? $phone['card_slot'] ?? '',
            
            // Display
            'display_type' => $_POST['display_type'] ?? $phone['display_type'] ?? '',
            'display_resolution' => $_POST['display_resolution'] ?? $phone['display_resolution'] ?? '',
            'display_size' => $_POST['display_size'] ?? $phone['display_size'] ?? '',
            'display_density' => $_POST['display_density'] ?? $phone['display_density'] ?? '',
            'display_technology' => $_POST['display_technology'] ?? $phone['display_technology'] ?? '',
            'display_notch' => $_POST['display_notch'] ?? $phone['display_notch'] ?? '',
            'refresh_rate' => $_POST['refresh_rate'] ?? $phone['refresh_rate'] ?? '',
            'hdr' => isset($_POST['hdr']),
            'billion_colors' => isset($_POST['billion_colors']),
            
            // Main Camera
            'main_camera_resolution' => $_POST['main_camera_resolution'] ?? $phone['main_camera_resolution'] ?? '',
            'main_camera_count' => $_POST['main_camera_count'] ?? $phone['main_camera_count'] ?? '',
            'main_camera_ois' => isset($_POST['main_camera_ois']),
            'main_camera_f_number' => $_POST['main_camera_f_number'] ?? $phone['main_camera_f_number'] ?? '',
            'main_camera_telephoto' => isset($_POST['main_camera_telephoto']),
            'main_camera_ultrawide' => isset($_POST['main_camera_ultrawide']),
            'main_camera_video' => $_POST['main_camera_video'] ?? $phone['main_camera_video'] ?? '',
            'main_camera_flash' => $_POST['main_camera_flash'] ?? $phone['main_camera_flash'] ?? '',
            
            // Selfie Camera
            'selfie_camera_resolution' => $_POST['selfie_camera_resolution'] ?? $phone['selfie_camera_resolution'] ?? '',
            'selfie_camera_count' => $_POST['selfie_camera_count'] ?? $phone['selfie_camera_count'] ?? '',
            'selfie_camera_ois' => isset($_POST['selfie_camera_ois']),
            'selfie_camera_flash' => isset($_POST['selfie_camera_flash']),
            'popup_camera' => isset($_POST['popup_camera']),
            'under_display_camera' => isset($_POST['under_display_camera']),
            
            // Audio
            'headphone_jack' => isset($_POST['headphone_jack']),
            'dual_speakers' => isset($_POST['dual_speakers']),
            
            // Sensors
            'accelerometer' => isset($_POST['accelerometer']),
            'gyro' => isset($_POST['gyro']),
            'compass' => isset($_POST['compass']),
            'proximity' => isset($_POST['proximity']),
            'barometer' => isset($_POST['barometer']),
            'heart_rate' => isset($_POST['heart_rate']),
            'fingerprint' => $_POST['fingerprint'] ?? $phone['fingerprint'] ?? '',
            
            // Connectivity
            'wifi' => $_POST['wifi'] ?? $phone['wifi'] ?? [],
            'bluetooth' => $_POST['bluetooth'] ?? $phone['bluetooth'] ?? [],
            'gps' => isset($_POST['gps']),
            'nfc' => isset($_POST['nfc']),
            'infrared' => isset($_POST['infrared']),
            'fm_radio' => isset($_POST['fm_radio']),
            'usb' => $_POST['usb'] ?? $phone['usb'] ?? '',
            
            // Battery
            'battery_capacity' => $_POST['battery_capacity'] ?? $phone['battery_capacity'] ?? '',
            'battery_sic' => isset($_POST['battery_sic']),
            'battery_removable' => isset($_POST['battery_removable']),
            'wired_charging' => $_POST['wired_charging'] ?? $phone['wired_charging'] ?? '',
            'wireless_charging' => $_POST['wireless_charging'] ?? $phone['wireless_charging'] ?? ''
        ];
        
        if (updatePhone($id, $updated_phone)) {
            // Set success message and redirect to dashboard
            $_SESSION['success_message'] = 'Phone updated successfully!';
            header('Location: dashboard.php');
            exit();
        } else {
            $errors['general'] = 'Failed to update phone data. Please try again.';
        }
    }
} else {
    // Pre-fill form with existing data
    $brand = $phone['brand'];
    $year = $phone['year'];
    $price = $phone['price'];
    
    // Handle both old (array) and new (string) format for availability
    if (isset($phone['availability'])) {
        if (is_array($phone['availability'])) {
            // For old format (array of checkboxes), set to empty so the dropdown shows "Select availability..."
            $availability = '';
        } else {
            $availability = $phone['availability'];
        }
    } else {
        $availability = '';
    }
    $network_3g = isset($phone['3g']) ? $phone['3g'] : false;
    $network_4g = isset($phone['4g']) ? $phone['4g'] : false;
    $network_5g = isset($phone['5g']) ? $phone['5g'] : false;
}
?>

<?php include 'includes/header.php'; ?>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1>Edit Phone</h1>
            <p class="text-muted">Update the details of the mobile phone</p>
        </div>
        <div class="col-auto">
            <a href="dashboard.php" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <?php if (isset($errors['general'])): ?>
    <div class="alert alert-danger">
        <?php echo htmlspecialchars($errors['general']); ?>
    </div>
    <?php endif; ?>

    <div class="card shadow">
        <div class="card-body">
            <form method="post" action="<?php echo htmlspecialchars($_SERVER['PHP_SELF']) . '?id=' . $id; ?>" enctype="multipart/form-data">
                
                <!-- 1. Launch Section -->
                <div class="accordion mb-4" id="phoneAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="launchHeader">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#launchCollapse" aria-expanded="true" aria-controls="launchCollapse">
                                <i class="fas fa-rocket me-2"></i> Launch
                            </button>
                        </h2>
                        <div id="launchCollapse" class="accordion-collapse collapse show" aria-labelledby="launchHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="release_date" class="form-label">Date of Release</label>
                                        <input type="date" class="form-control" id="release_date" name="release_date" 
                                               value="<?php echo htmlspecialchars($phone['release_date'] ?? ''); ?>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. General Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="generalHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#generalCollapse" aria-expanded="false" aria-controls="generalCollapse">
                                <i class="fas fa-info-circle me-2"></i> General
                            </button>
                        </h2>
                        <div id="generalCollapse" class="accordion-collapse collapse" aria-labelledby="generalHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">Name *</label>
                                        <input type="text" class="form-control <?php echo isset($errors['name']) ? 'is-invalid' : ''; ?>" 
                                               id="name" name="name" value="<?php echo htmlspecialchars($phone['name'] ?? $phone['brand'] ?? ''); ?>" required>
                                        <?php if (isset($errors['name'])): ?>
                                            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['name']); ?></div>
                                        <?php endif; ?>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="brand" class="form-label">Brand *</label>
                                        <div class="input-group">
                                            <select class="form-select <?php echo isset($errors['brand']) ? 'is-invalid' : ''; ?>" 
                                                    id="brand" name="brand" required>
                                                <option value="">Select a brand...</option>
                                                <?php 
                                                $brands = getAllBrands();
                                                if (!empty($brands)) {
                                                    foreach ($brands as $brandItem) {
                                                        $selected = ($phone['brand'] === $brandItem['name']) ? 'selected' : '';
                                                        echo '<option value="' . htmlspecialchars($brandItem['name']) . '" ' . $selected . '>' . 
                                                            htmlspecialchars($brandItem['name']) . '</option>';
                                                    }
                                                }
                                                ?>
                                                <option value="other" <?php echo !in_array($phone['brand'], array_column($brands, 'name')) ? 'selected' : ''; ?>>Other (Custom)</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="window.location.href='manage_data.php';"
                                                    <?php echo (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') ? 'disabled' : ''; ?>
                                                    title="<?php echo (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') ? 'Only admin can manage brands' : 'Manage Brands'; ?>">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <div id="custom-brand-container" class="mt-2 <?php echo in_array($phone['brand'], array_column($brands, 'name')) ? 'd-none' : ''; ?>">
                                            <input type="text" class="form-control" id="custom-brand" 
                                                   placeholder="Enter custom brand name" 
                                                   value="<?php echo !in_array($phone['brand'], array_column($brands, 'name')) ? htmlspecialchars($phone['brand']) : ''; ?>">
                                        </div>
                                        <?php if (isset($errors['brand'])): ?>
                                            <div class="invalid-feedback d-block"><?php echo htmlspecialchars($errors['brand']); ?></div>
                                        <?php endif; ?>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="year" class="form-label">Year *</label>
                                        <input type="number" class="form-control <?php echo isset($errors['year']) ? 'is-invalid' : ''; ?>" 
                                               id="year" name="year" min="2000" max="<?php echo date('Y') + 2; ?>" 
                                               value="<?php echo htmlspecialchars($phone['year'] ?? date('Y')); ?>" required>
                                        <?php if (isset($errors['year'])): ?>
                                            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['year']); ?></div>
                                        <?php endif; ?>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="availability" class="form-label">Availability *</label>
                                        <select class="form-select <?php echo isset($errors['availability']) ? 'is-invalid' : ''; ?>" 
                                                id="availability" name="availability" required>
                                            <option value="">Select availability...</option>
                                            <option value="Available" <?php echo ($phone['availability'] ?? '') === 'Available' ? 'selected' : ''; ?>>Available</option>
                                            <option value="Coming Soon" <?php echo ($phone['availability'] ?? '') === 'Coming Soon' ? 'selected' : ''; ?>>Coming Soon</option>
                                            <option value="Discontinued" <?php echo ($phone['availability'] ?? '') === 'Discontinued' ? 'selected' : ''; ?>>Discontinued</option>
                                            <option value="Rumored" <?php echo ($phone['availability'] ?? '') === 'Rumored' ? 'selected' : ''; ?>>Rumored</option>
                                        </select>
                                        <?php if (isset($errors['availability'])): ?>
                                            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['availability']); ?></div>
                                        <?php endif; ?>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="price" class="form-label">Price (USD) *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" class="form-control <?php echo isset($errors['price']) ? 'is-invalid' : ''; ?>" 
                                                   id="price" name="price" min="0.01" 
                                                   value="<?php echo htmlspecialchars($phone['price'] ?? ''); ?>" required>
                                            <?php if (isset($errors['price'])): ?>
                                                <div class="invalid-feedback"><?php echo htmlspecialchars($errors['price']); ?></div>
                                            <?php endif; ?>
                                        </div>
                                    </div>

                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Phone Images (up to 5)</label>
                                        
                                        <!-- Current Images Display -->
                                        <?php if (!empty($phone['images']) && is_array($phone['images'])): ?>
                                        <div class="mb-3">
                                            <div class="form-text">Current images:</div>
                                            <div class="row">
                                                <?php foreach ($phone['images'] as $index => $current_image): ?>
                                                <div class="col-md-3 mb-2">
                                                    <img src="<?php echo htmlspecialchars($current_image); ?>" 
                                                         alt="Current Image <?php echo $index + 1; ?>" 
                                                         class="img-thumbnail" style="max-height: 100px; width: 100%;">
                                                    <div class="form-text text-center">Image <?php echo $index + 1; ?><?php echo $index === 0 ? ' (Main)' : ''; ?></div>
                                                </div>
                                                <?php endforeach; ?>
                                            </div>
                                        </div>
                                        <?php elseif (!empty($phone['image'])): ?>
                                        <div class="mb-3">
                                            <div class="form-text">Current image:</div>
                                            <img src="<?php echo htmlspecialchars($phone['image']); ?>" alt="Current Phone Image" class="img-thumbnail" style="max-height: 100px;">
                                            <div class="form-text">Main image</div>
                                        </div>
                                        <?php endif; ?>
                                        
                                        <!-- New Images Upload -->
                                        <div class="row">
                                            <div class="col-md-4 mb-2">
                                                <label for="image1" class="form-label">New Image 1 (Main)</label>
                                                <input type="file" class="form-control <?php echo isset($errors['image1']) ? 'is-invalid' : ''; ?>" 
                                                       id="image1" name="images[]" accept="image/jpeg, image/png, image/gif">
                                                <?php if (isset($errors['image1'])): ?>
                                                    <div class="invalid-feedback"><?php echo htmlspecialchars($errors['image1']); ?></div>
                                                <?php endif; ?>
                                            </div>
                                            <div class="col-md-4 mb-2">
                                                <label for="image2" class="form-label">New Image 2</label>
                                                <input type="file" class="form-control <?php echo isset($errors['image2']) ? 'is-invalid' : ''; ?>" 
                                                       id="image2" name="images[]" accept="image/jpeg, image/png, image/gif">
                                                <?php if (isset($errors['image2'])): ?>
                                                    <div class="invalid-feedback"><?php echo htmlspecialchars($errors['image2']); ?></div>
                                                <?php endif; ?>
                                            </div>
                                            <div class="col-md-4 mb-2">
                                                <label for="image3" class="form-label">New Image 3</label>
                                                <input type="file" class="form-control <?php echo isset($errors['image3']) ? 'is-invalid' : ''; ?>" 
                                                       id="image3" name="images[]" accept="image/jpeg, image/png, image/gif">
                                                <?php if (isset($errors['image3'])): ?>
                                                    <div class="invalid-feedback"><?php echo htmlspecialchars($errors['image3']); ?></div>
                                                <?php endif; ?>
                                            </div>
                                            <div class="col-md-4 mb-2">
                                                <label for="image4" class="form-label">New Image 4</label>
                                                <input type="file" class="form-control <?php echo isset($errors['image4']) ? 'is-invalid' : ''; ?>" 
                                                       id="image4" name="images[]" accept="image/jpeg, image/png, image/gif">
                                                <?php if (isset($errors['image4'])): ?>
                                                    <div class="invalid-feedback"><?php echo htmlspecialchars($errors['image4']); ?></div>
                                                <?php endif; ?>
                                            </div>
                                            <div class="col-md-4 mb-2">
                                                <label for="image5" class="form-label">New Image 5</label>
                                                <input type="file" class="form-control <?php echo isset($errors['image5']) ? 'is-invalid' : ''; ?>" 
                                                       id="image5" name="images[]" accept="image/jpeg, image/png, image/gif">
                                                <?php if (isset($errors['image5'])): ?>
                                                    <div class="invalid-feedback"><?php echo htmlspecialchars($errors['image5']); ?></div>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        <div class="form-text">Max size per image: 5MB. Formats: JPG, PNG, GIF. Leave empty to keep current images. Uploading new images will replace all existing ones.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Network Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="networkHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#networkCollapse" aria-expanded="false" aria-controls="networkCollapse">
                                <i class="fas fa-signal me-2"></i> Network
                            </button>
                        </h2>
                        <div id="networkCollapse" class="accordion-collapse collapse" aria-labelledby="networkHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">2G</label>
                                        <?php $current_2g = $phone['2g'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="2g[]" value="GSM 850" id="2g_850" <?php echo in_array('GSM 850', $current_2g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="2g_850">GSM 850</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="2g[]" value="GSM 900" id="2g_900" <?php echo in_array('GSM 900', $current_2g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="2g_900">GSM 900</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="2g[]" value="GSM 1800" id="2g_1800" <?php echo in_array('GSM 1800', $current_2g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="2g_1800">GSM 1800</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="2g[]" value="GSM 1900" id="2g_1900" <?php echo in_array('GSM 1900', $current_2g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="2g_1900">GSM 1900</label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">3G</label>
                                        <?php $current_3g = $phone['3g'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="3g[]" value="HSPA 850" id="3g_850" <?php echo in_array('HSPA 850', $current_3g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="3g_850">HSPA 850</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="3g[]" value="HSPA 900" id="3g_900" <?php echo in_array('HSPA 900', $current_3g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="3g_900">HSPA 900</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="3g[]" value="HSPA 1700" id="3g_1700" <?php echo in_array('HSPA 1700', $current_3g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="3g_1700">HSPA 1700</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="3g[]" value="HSPA 1900" id="3g_1900" <?php echo in_array('HSPA 1900', $current_3g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="3g_1900">HSPA 1900</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="3g[]" value="HSPA 2100" id="3g_2100" <?php echo in_array('HSPA 2100', $current_3g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="3g_2100">HSPA 2100</label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">4G</label>
                                        <?php $current_4g = $phone['4g'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="4g[]" value="LTE 700" id="4g_700" <?php echo in_array('LTE 700', $current_4g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="4g_700">LTE 700</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="4g[]" value="LTE 850" id="4g_850" <?php echo in_array('LTE 850', $current_4g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="4g_850">LTE 850</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="4g[]" value="LTE 900" id="4g_900" <?php echo in_array('LTE 900', $current_4g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="4g_900">LTE 900</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="4g[]" value="LTE 1800" id="4g_1800" <?php echo in_array('LTE 1800', $current_4g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="4g_1800">LTE 1800</label>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">5G</label>
                                        <?php $current_5g = $phone['5g'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="5g[]" value="NR 3500" id="5g_3500" <?php echo in_array('NR 3500', $current_5g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="5g_3500">NR 3500</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="5g[]" value="NR 3600" id="5g_3600" <?php echo in_array('NR 3600', $current_5g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="5g_3600">NR 3600</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="5g[]" value="NR 3700" id="5g_3700" <?php echo in_array('NR 3700', $current_5g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="5g_3700">NR 3700</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="5g[]" value="NR 3800" id="5g_3800" <?php echo in_array('NR 3800', $current_5g) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="5g_3800">NR 3800</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. SIM Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="simHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#simCollapse" aria-expanded="false" aria-controls="simCollapse">
                                <i class="fas fa-sim-card me-2"></i> SIM
                            </button>
                        </h2>
                        <div id="simCollapse" class="accordion-collapse collapse" aria-labelledby="simHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="dual_sim" id="dual_sim" <?php echo ($phone['dual_sim'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="dual_sim">Dual SIM</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="esim" id="esim" <?php echo ($phone['esim'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="esim">eSIM</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Size</label>
                                        <?php $current_sim_size = $phone['sim_size'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="sim_size[]" value="Mini-SIM" id="sim_mini" <?php echo in_array('Mini-SIM', $current_sim_size) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="sim_mini">Mini-SIM</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="sim_size[]" value="Nano-SIM" id="sim_nano" <?php echo in_array('Nano-SIM', $current_sim_size) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="sim_nano">Nano-SIM</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="sim_size[]" value="Micro-SIM" id="sim_micro" <?php echo in_array('Micro-SIM', $current_sim_size) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="sim_micro">Micro-SIM</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Platform Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="platformHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#platformCollapse" aria-expanded="false" aria-controls="platformCollapse">
                                <i class="fas fa-microchip me-2"></i> Platform
                            </button>
                        </h2>
                        <div id="platformCollapse" class="accordion-collapse collapse" aria-labelledby="platformHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="os" class="form-label">OS</label>
                                        <select class="form-select" id="os" name="os">
                                            <option value="">Select OS...</option>
                                            <option value="Feature phones" <?php echo ($phone['os'] ?? '') === 'Feature phones' ? 'selected' : ''; ?>>Feature phones</option>
                                            <option value="Android" <?php echo ($phone['os'] ?? '') === 'Android' ? 'selected' : ''; ?>>Android</option>
                                            <option value="iOS" <?php echo ($phone['os'] ?? '') === 'iOS' ? 'selected' : ''; ?>>iOS</option>
                                            <option value="KaiOS" <?php echo ($phone['os'] ?? '') === 'KaiOS' ? 'selected' : ''; ?>>KaiOS</option>
                                            <option value="Windows Phone" <?php echo ($phone['os'] ?? '') === 'Windows Phone' ? 'selected' : ''; ?>>Windows Phone</option>
                                            <option value="Symbian" <?php echo ($phone['os'] ?? '') === 'Symbian' ? 'selected' : ''; ?>>Symbian</option>
                                            <option value="RIM" <?php echo ($phone['os'] ?? '') === 'RIM' ? 'selected' : ''; ?>>RIM</option>
                                            <option value="Bada" <?php echo ($phone['os'] ?? '') === 'Bada' ? 'selected' : ''; ?>>Bada</option>
                                            <option value="Firefox" <?php echo ($phone['os'] ?? '') === 'Firefox' ? 'selected' : ''; ?>>Firefox</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="os_version" class="form-label">OS Version</label>
                                        <input type="text" class="form-control" id="os_version" name="os_version" 
                                               placeholder="e.g., Android 14" value="<?php echo htmlspecialchars($phone['os_version'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="chipset" class="form-label">Chipset</label>
                                        <div class="input-group">
                                            <select class="form-select" id="chipset" name="chipset">
                                                <option value="">Select chipset...</option>
                                                <?php 
                                                $chipsets = getAllChipsets();
                                                if (!empty($chipsets)) {
                                                    foreach ($chipsets as $chipsetItem) {
                                                        $selected = ($phone['chipset'] === $chipsetItem['name']) ? 'selected' : '';
                                                        echo '<option value="' . htmlspecialchars($chipsetItem['name']) . '" ' . $selected . '>' . 
                                                            htmlspecialchars($chipsetItem['name']) . '</option>';
                                                    }
                                                }
                                                ?>
                                                <option value="other" <?php echo !in_array($phone['chipset'] ?? '', array_column($chipsets, 'name')) ? 'selected' : ''; ?>>Other (Custom)</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="window.location.href='manage_data.php';"
                                                    <?php echo (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') ? 'disabled' : ''; ?>
                                                    title="<?php echo (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') ? 'Only admin can manage chipsets' : 'Manage Chipsets'; ?>">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <div id="custom-chipset-container" class="mt-2 <?php echo in_array($phone['chipset'] ?? '', array_column($chipsets, 'name')) ? 'd-none' : ''; ?>">
                                            <input type="text" class="form-control" id="custom-chipset" 
                                                   placeholder="Enter custom chipset name" 
                                                   value="<?php echo !in_array($phone['chipset'] ?? '', array_column($chipsets, 'name')) ? htmlspecialchars($phone['chipset'] ?? '') : ''; ?>">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cpu_cores" class="form-label">CPU Cores</label>
                                        <input type="number" class="form-control" id="cpu_cores" name="cpu_cores" min="1" max="16" 
                                               value="<?php echo htmlspecialchars($phone['cpu_cores'] ?? ''); ?>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 6. Body Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="bodyHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bodyCollapse" aria-expanded="false" aria-controls="bodyCollapse">
                                <i class="fas fa-mobile-alt me-2"></i> Body
                            </button>
                        </h2>
                        <div id="bodyCollapse" class="accordion-collapse collapse" aria-labelledby="bodyHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="dimensions" class="form-label">Dimensions</label>
                                        <input type="text" class="form-control" id="dimensions" name="dimensions" 
                                               placeholder="e.g., 146.3 x 70.9 x 7.6 mm" value="<?php echo htmlspecialchars($phone['dimensions'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="form_factor" class="form-label">Form Factor</label>
                                        <select class="form-select" id="form_factor" name="form_factor">
                                            <option value="">Select form factor...</option>
                                            <option value="Bar" <?php echo ($phone['form_factor'] ?? '') === 'Bar' ? 'selected' : ''; ?>>Bar</option>
                                            <option value="Foldable" <?php echo ($phone['form_factor'] ?? '') === 'Foldable' ? 'selected' : ''; ?>>Foldable</option>
                                            <option value="Flip" <?php echo ($phone['form_factor'] ?? '') === 'Flip' ? 'selected' : ''; ?>>Flip</option>
                                            <option value="Slider" <?php echo ($phone['form_factor'] ?? '') === 'Slider' ? 'selected' : ''; ?>>Slider</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="height" class="form-label">Height (mm)</label>
                                        <input type="number" step="0.1" class="form-control" id="height" name="height" 
                                               value="<?php echo htmlspecialchars($phone['height'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="width" class="form-label">Width (mm)</label>
                                        <input type="number" step="0.1" class="form-control" id="width" name="width" 
                                               value="<?php echo htmlspecialchars($phone['width'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="thickness" class="form-label">Thickness (mm)</label>
                                        <input type="number" step="0.1" class="form-control" id="thickness" name="thickness" 
                                               value="<?php echo htmlspecialchars($phone['thickness'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="weight" class="form-label">Weight (g)</label>
                                        <input type="number" class="form-control" id="weight" name="weight" 
                                               value="<?php echo htmlspecialchars($phone['weight'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">IP Certificate</label>
                                        <?php $current_ip = $phone['ip_certificate'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="ip_certificate[]" value="IP53" id="ip53" <?php echo in_array('IP53', $current_ip) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="ip53">IP53</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="ip_certificate[]" value="IP68" id="ip68" <?php echo in_array('IP68', $current_ip) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="ip68">IP68</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="color" class="form-label">Color</label>
                                        <input type="text" class="form-control" id="color" name="color" 
                                               placeholder="e.g., Phantom Black, Ocean Blue" value="<?php echo htmlspecialchars($phone['color'] ?? ''); ?>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 7. Memory Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="memoryHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#memoryCollapse" aria-expanded="false" aria-controls="memoryCollapse">
                                <i class="fas fa-memory me-2"></i> Memory
                            </button>
                        </h2>
                        <div id="memoryCollapse" class="accordion-collapse collapse" aria-labelledby="memoryHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="ram" class="form-label">RAM (GB)</label>
                                        <input type="number" step="0.5" class="form-control" id="ram" name="ram" min="0.5" max="64" 
                                               value="<?php echo htmlspecialchars($phone['ram'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="storage" class="form-label">Storage (GB)</label>
                                        <input type="number" class="form-control" id="storage" name="storage" min="1" max="2048" 
                                               value="<?php echo htmlspecialchars($phone['storage'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="card_slot" class="form-label">Card Slot</label>
                                        <select class="form-select" id="card_slot" name="card_slot">
                                            <option value="">Select option...</option>
                                            <option value="Yes (any type)" <?php echo ($phone['card_slot'] ?? '') === 'Yes (any type)' ? 'selected' : ''; ?>>Yes (any type)</option>
                                            <option value="Yes (dedicated)" <?php echo ($phone['card_slot'] ?? '') === 'Yes (dedicated)' ? 'selected' : ''; ?>>Yes (dedicated)</option>
                                            <option value="No" <?php echo ($phone['card_slot'] ?? '') === 'No' ? 'selected' : ''; ?>>No</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 8. Display Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="displayHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#displayCollapse" aria-expanded="false" aria-controls="displayCollapse">
                                <i class="fas fa-tv me-2"></i> Display
                            </button>
                        </h2>
                        <div id="displayCollapse" class="accordion-collapse collapse" aria-labelledby="displayHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="display_type" class="form-label">Type</label>
                                        <select class="form-select" id="display_type" name="display_type">
                                            <option value="">Select type...</option>
                                            <option value="AMOLED" <?php echo ($phone['display_type'] ?? '') === 'AMOLED' ? 'selected' : ''; ?>>AMOLED</option>
                                            <option value="Super AMOLED" <?php echo ($phone['display_type'] ?? '') === 'Super AMOLED' ? 'selected' : ''; ?>>Super AMOLED</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="display_resolution" class="form-label">Resolution</label>
                                        <input type="text" class="form-control" id="display_resolution" name="display_resolution" 
                                               placeholder="e.g., 1080 x 2400 pixels" value="<?php echo htmlspecialchars($phone['display_resolution'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="display_size" class="form-label">Size (inches)</label>
                                        <input type="number" step="0.1" class="form-control" id="display_size" name="display_size" 
                                               min="2" max="15" value="<?php echo htmlspecialchars($phone['display_size'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="display_density" class="form-label">Density (ppi)</label>
                                        <input type="number" class="form-control" id="display_density" name="display_density" 
                                               min="50" max="1000" value="<?php echo htmlspecialchars($phone['display_density'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="display_technology" class="form-label">Technology</label>
                                        <select class="form-select" id="display_technology" name="display_technology">
                                            <option value="">Select technology...</option>
                                            <option value="IPS" <?php echo ($phone['display_technology'] ?? '') === 'IPS' ? 'selected' : ''; ?>>IPS</option>
                                            <option value="Any OLED" <?php echo ($phone['display_technology'] ?? '') === 'Any OLED' ? 'selected' : ''; ?>>Any OLED</option>
                                            <option value="LTPO OLED" <?php echo ($phone['display_technology'] ?? '') === 'LTPO OLED' ? 'selected' : ''; ?>>LTPO OLED</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="display_notch" class="form-label">Notch</label>
                                        <select class="form-select" id="display_notch" name="display_notch">
                                            <option value="">Select option...</option>
                                            <option value="No" <?php echo ($phone['display_notch'] ?? '') === 'No' ? 'selected' : ''; ?>>No</option>
                                            <option value="Yes" <?php echo ($phone['display_notch'] ?? '') === 'Yes' ? 'selected' : ''; ?>>Yes</option>
                                            <option value="Punch Hole" <?php echo ($phone['display_notch'] ?? '') === 'Punch Hole' ? 'selected' : ''; ?>>Punch Hole</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="refresh_rate" class="form-label">Refresh Rate</label>
                                        <select class="form-select" id="refresh_rate" name="refresh_rate">
                                            <option value="">Select rate...</option>
                                            <option value="90Hz" <?php echo ($phone['refresh_rate'] ?? '') === '90Hz' ? 'selected' : ''; ?>>90Hz</option>
                                            <option value="120Hz" <?php echo ($phone['refresh_rate'] ?? '') === '120Hz' ? 'selected' : ''; ?>>120Hz</option>
                                            <option value="144Hz" <?php echo ($phone['refresh_rate'] ?? '') === '144Hz' ? 'selected' : ''; ?>>144Hz</option>
                                            <option value="165Hz" <?php echo ($phone['refresh_rate'] ?? '') === '165Hz' ? 'selected' : ''; ?>>165Hz</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" name="hdr" id="hdr" <?php echo isset($phone['hdr']) && $phone['hdr'] ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="hdr">HDR</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="billion_colors" id="billion_colors" <?php echo isset($phone['billion_colors']) && $phone['billion_colors'] ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="billion_colors">1B+ Colors</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 8. Display Section -->
                            </button>
                        </h2>
                        <div id="displayCollapse" class="accordion-collapse collapse" aria-labelledby="displayHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="display_type" class="form-label">Type</label>
                                        <select class="form-select" id="display_type" name="display_type">
                                            <option value="">Select type...</option>
                                            <option value="AMOLED" <?php echo ($phone['display_type'] ?? '') === 'AMOLED' ? 'selected' : ''; ?>>AMOLED</option>
                                            <option value="Super AMOLED" <?php echo ($phone['display_type'] ?? '') === 'Super AMOLED' ? 'selected' : ''; ?>>Super AMOLED</option>
                                            <option value="IPS LCD" <?php echo ($phone['display_type'] ?? '') === 'IPS LCD' ? 'selected' : ''; ?>>IPS LCD</option>
                                            <option value="OLED" <?php echo ($phone['display_type'] ?? '') === 'OLED' ? 'selected' : ''; ?>>OLED</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="display_resolution" class="form-label">Resolution</label>
                                        <input type="text" class="form-control" id="display_resolution" name="display_resolution" 
                                               placeholder="e.g., 1080 x 2400 pixels" value="<?php echo htmlspecialchars($phone['display_resolution'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="display_size" class="form-label">Size (inches)</label>
                                        <input type="number" step="0.1" class="form-control" id="display_size" name="display_size" min="2" max="15" 
                                               value="<?php echo htmlspecialchars($phone['display_size'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="display_density" class="form-label">Density (ppi)</label>
                                        <input type="number" class="form-control" id="display_density" name="display_density" min="50" max="1000" 
                                               value="<?php echo htmlspecialchars($phone['display_density'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="refresh_rate" class="form-label">Refresh Rate</label>
                                        <select class="form-select" id="refresh_rate" name="refresh_rate">
                                            <option value="">Select rate...</option>
                                            <option value="60Hz" <?php echo ($phone['refresh_rate'] ?? '') === '60Hz' ? 'selected' : ''; ?>>60Hz</option>
                                            <option value="90Hz" <?php echo ($phone['refresh_rate'] ?? '') === '90Hz' ? 'selected' : ''; ?>>90Hz</option>
                                            <option value="120Hz" <?php echo ($phone['refresh_rate'] ?? '') === '120Hz' ? 'selected' : ''; ?>>120Hz</option>
                                            <option value="144Hz" <?php echo ($phone['refresh_rate'] ?? '') === '144Hz' ? 'selected' : ''; ?>>144Hz</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" name="hdr" id="hdr" <?php echo ($phone['hdr'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="hdr">HDR</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="billion_colors" id="billion_colors" <?php echo ($phone['billion_colors'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="billion_colors">1B+ Colors</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 9. Main Camera Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="mainCameraHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mainCameraCollapse" aria-expanded="false" aria-controls="mainCameraCollapse">
                                <i class="fas fa-camera me-2"></i> Main Camera
                            </button>
                        </h2>
                        <div id="mainCameraCollapse" class="accordion-collapse collapse" aria-labelledby="mainCameraHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="main_camera_resolution" class="form-label">Resolution (MP)</label>
                                        <input type="number" class="form-control" id="main_camera_resolution" name="main_camera_resolution" 
                                               min="0.1" max="200" step="0.1" value="<?php echo htmlspecialchars($phone['main_camera_resolution'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="main_camera_count" class="form-label">Cameras</label>
                                        <select class="form-select" id="main_camera_count" name="main_camera_count">
                                            <option value="">Select count...</option>
                                            <option value="One" <?php echo ($phone['main_camera_count'] ?? '') === 'One' ? 'selected' : ''; ?>>One</option>
                                            <option value="Two" <?php echo ($phone['main_camera_count'] ?? '') === 'Two' ? 'selected' : ''; ?>>Two</option>
                                            <option value="Three" <?php echo ($phone['main_camera_count'] ?? '') === 'Three' ? 'selected' : ''; ?>>Three</option>
                                            <option value="Four or More" <?php echo ($phone['main_camera_count'] ?? '') === 'Four or More' ? 'selected' : ''; ?>>Four or More</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="main_camera_ois" id="main_camera_ois" <?php echo ($phone['main_camera_ois'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="main_camera_ois">OIS (Optical Image Stabilization)</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="main_camera_telephoto" id="main_camera_telephoto" <?php echo ($phone['main_camera_telephoto'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="main_camera_telephoto">Telephoto</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="main_camera_ultrawide" id="main_camera_ultrawide" <?php echo ($phone['main_camera_ultrawide'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="main_camera_ultrawide">Ultra-wide</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="main_camera_video" class="form-label">Video Recording</label>
                                        <select class="form-select" id="main_camera_video" name="main_camera_video">
                                            <option value="">Select option...</option>
                                            <option value="4K@30fps" <?php echo ($phone['main_camera_video'] ?? '') === '4K@30fps' ? 'selected' : ''; ?>>4K@30fps</option>
                                            <option value="4K@60fps" <?php echo ($phone['main_camera_video'] ?? '') === '4K@60fps' ? 'selected' : ''; ?>>4K@60fps</option>
                                            <option value="8K@30fps" <?php echo ($phone['main_camera_video'] ?? '') === '8K@30fps' ? 'selected' : ''; ?>>8K@30fps</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 10. Selfie Camera Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="selfieCameraHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#selfieCameraCollapse" aria-expanded="false" aria-controls="selfieCameraCollapse">
                                <i class="fas fa-camera-retro me-2"></i> Selfie Camera
                            </button>
                        </h2>
                        <div id="selfieCameraCollapse" class="accordion-collapse collapse" aria-labelledby="selfieCameraHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="selfie_camera_resolution" class="form-label">Resolution (MP)</label>
                                        <input type="number" class="form-control" id="selfie_camera_resolution" name="selfie_camera_resolution" 
                                               min="0.1" max="108" step="0.1" value="<?php echo htmlspecialchars($phone['selfie_camera_resolution'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="selfie_camera_count" class="form-label">Cameras</label>
                                        <select class="form-select" id="selfie_camera_count" name="selfie_camera_count">
                                            <option value="">Select count...</option>
                                            <option value="One" <?php echo ($phone['selfie_camera_count'] ?? '') === 'One' ? 'selected' : ''; ?>>One</option>
                                            <option value="Two" <?php echo ($phone['selfie_camera_count'] ?? '') === 'Two' ? 'selected' : ''; ?>>Two</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="selfie_camera_ois" id="selfie_camera_ois" <?php echo ($phone['selfie_camera_ois'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="selfie_camera_ois">OIS</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="selfie_camera_flash" id="selfie_camera_flash" <?php echo ($phone['selfie_camera_flash'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="selfie_camera_flash">Flash</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="popup_camera" id="popup_camera" <?php echo ($phone['popup_camera'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="popup_camera">Pop-up Camera</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="under_display_camera" id="under_display_camera" <?php echo ($phone['under_display_camera'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="under_display_camera">Under-display Camera</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 11. Audio Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="audioHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#audioCollapse" aria-expanded="false" aria-controls="audioCollapse">
                                <i class="fas fa-headphones me-2"></i> Audio
                            </button>
                        </h2>
                        <div id="audioCollapse" class="accordion-collapse collapse" aria-labelledby="audioHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="headphone_jack" id="headphone_jack" <?php echo ($phone['headphone_jack'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="headphone_jack">3.5mm Headphone Jack</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="dual_speakers" id="dual_speakers" <?php echo ($phone['dual_speakers'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="dual_speakers">Dual Speakers</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 12. Sensors Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="sensorsHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sensorsCollapse" aria-expanded="false" aria-controls="sensorsCollapse">
                                <i class="fas fa-microchip me-2"></i> Sensors
                            </button>
                        </h2>
                        <div id="sensorsCollapse" class="accordion-collapse collapse" aria-labelledby="sensorsHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="accelerometer" id="accelerometer" <?php echo ($phone['accelerometer'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="accelerometer">Accelerometer</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="gyro" id="gyro" <?php echo ($phone['gyro'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="gyro">Gyroscope</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="compass" id="compass" <?php echo ($phone['compass'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="compass">Compass</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="proximity" id="proximity" <?php echo ($phone['proximity'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="proximity">Proximity</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="barometer" id="barometer" <?php echo ($phone['barometer'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="barometer">Barometer</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="heart_rate" id="heart_rate" <?php echo ($phone['heart_rate'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="heart_rate">Heart Rate</label>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="fingerprint" class="form-label">Fingerprint</label>
                                        <select class="form-select" id="fingerprint" name="fingerprint">
                                            <option value="">Select option...</option>
                                            <option value="Yes (rear)" <?php echo ($phone['fingerprint'] ?? '') === 'Yes (rear)' ? 'selected' : ''; ?>>Yes (rear)</option>
                                            <option value="Yes (side)" <?php echo ($phone['fingerprint'] ?? '') === 'Yes (side)' ? 'selected' : ''; ?>>Yes (side)</option>
                                            <option value="Yes (under display)" <?php echo ($phone['fingerprint'] ?? '') === 'Yes (under display)' ? 'selected' : ''; ?>>Yes (under display)</option>
                                            <option value="No" <?php echo ($phone['fingerprint'] ?? '') === 'No' ? 'selected' : ''; ?>>No</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 13. Connectivity Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="connectivityHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#connectivityCollapse" aria-expanded="false" aria-controls="connectivityCollapse">
                                <i class="fas fa-wifi me-2"></i> Connectivity
                            </button>
                        </h2>
                        <div id="connectivityCollapse" class="accordion-collapse collapse" aria-labelledby="connectivityHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">WiFi</label>
                                        <?php $current_wifi = $phone['wifi'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="wifi[]" value="802.11 a/b/g/n/ac" id="wifi_ac" <?php echo in_array('802.11 a/b/g/n/ac', $current_wifi) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="wifi_ac">802.11 a/b/g/n/ac</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="wifi[]" value="WiFi 6" id="wifi_6" <?php echo in_array('WiFi 6', $current_wifi) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="wifi_6">WiFi 6</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="wifi[]" value="WiFi 6E" id="wifi_6e" <?php echo in_array('WiFi 6E', $current_wifi) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="wifi_6e">WiFi 6E</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Bluetooth</label>
                                        <?php $current_bluetooth = $phone['bluetooth'] ?? []; ?>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="bluetooth[]" value="5.0" id="bt_50" <?php echo in_array('5.0', $current_bluetooth) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="bt_50">5.0</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="bluetooth[]" value="5.1" id="bt_51" <?php echo in_array('5.1', $current_bluetooth) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="bt_51">5.1</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="bluetooth[]" value="5.3" id="bt_53" <?php echo in_array('5.3', $current_bluetooth) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="bt_53">5.3</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="gps" id="gps" <?php echo ($phone['gps'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="gps">GPS</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="nfc" id="nfc" <?php echo ($phone['nfc'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="nfc">NFC</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="infrared" id="infrared" <?php echo ($phone['infrared'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="infrared">Infrared</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="fm_radio" id="fm_radio" <?php echo ($phone['fm_radio'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="fm_radio">FM Radio</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="usb" class="form-label">USB</label>
                                        <select class="form-select" id="usb" name="usb">
                                            <option value="">Select USB type...</option>
                                            <option value="USB Type-C" <?php echo ($phone['usb'] ?? '') === 'USB Type-C' ? 'selected' : ''; ?>>USB Type-C</option>
                                            <option value="Lightning" <?php echo ($phone['usb'] ?? '') === 'Lightning' ? 'selected' : ''; ?>>Lightning</option>
                                            <option value="Micro USB" <?php echo ($phone['usb'] ?? '') === 'Micro USB' ? 'selected' : ''; ?>>Micro USB</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 14. Battery Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="batteryHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#batteryCollapse" aria-expanded="false" aria-controls="batteryCollapse">
                                <i class="fas fa-battery-three-quarters me-2"></i> Battery
                            </button>
                        </h2>
                        <div id="batteryCollapse" class="accordion-collapse collapse" aria-labelledby="batteryHeader">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="battery_capacity" class="form-label">Capacity (mAh)</label>
                                        <input type="number" class="form-control" id="battery_capacity" name="battery_capacity" 
                                               min="500" max="10000" value="<?php echo htmlspecialchars($phone['battery_capacity'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="wired_charging" class="form-label">Wired Charging (W)</label>
                                        <input type="number" class="form-control" id="wired_charging" name="wired_charging" 
                                               min="5" max="300" value="<?php echo htmlspecialchars($phone['wired_charging'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="wireless_charging" class="form-label">Wireless Charging (W)</label>
                                        <input type="number" class="form-control" id="wireless_charging" name="wireless_charging" 
                                               min="5" max="50" value="<?php echo htmlspecialchars($phone['wireless_charging'] ?? ''); ?>">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="battery_sic" id="battery_sic" <?php echo ($phone['battery_sic'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="battery_sic">Silicon-Carbon (SiC) Battery</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="battery_removable" id="battery_removable" <?php echo ($phone['battery_removable'] ?? false) ? 'checked' : ''; ?>>
                                            <label class="form-check-label" for="battery_removable">Removable Battery</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="d-flex justify-content-end mt-3">
                    <a href="dashboard.php" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Update Phone</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all accordion sections
    const accordionButtons = document.querySelectorAll('.accordion-button');
    accordionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = document.querySelector(this.dataset.bsTarget);
            if (target) {
                const bsCollapse = new bootstrap.Collapse(target);
            }
        });
    });

    // Brand dropdown handling
    const brandSelect = document.getElementById('brand');
    brandSelect.addEventListener('change', function() {
        const brandContainer = document.getElementById('custom-brand-container');
        const customBrandInput = document.getElementById('custom-brand');
        
        if (this.value === 'other') {
            brandContainer.classList.remove('d-none');
            customBrandInput.required = true;
        } else {
            brandContainer.classList.add('d-none');
            customBrandInput.required = false;
            customBrandInput.value = '';
        }
    });

    // Chipset dropdown handling
    const chipsetSelect = document.getElementById('chipset');
    chipsetSelect.addEventListener('change', function() {
        const chipsetContainer = document.getElementById('custom-chipset-container');
        const customChipsetInput = document.getElementById('custom-chipset');
        
        if (this.value === 'other') {
            chipsetContainer.classList.remove('d-none');
            customChipsetInput.required = true;
        } else {
            chipsetContainer.classList.add('d-none');
            customChipsetInput.required = false;
            customChipsetInput.value = '';
        }
    });

    // Form submission handler for custom values
    document.querySelector('form').addEventListener('submit', function() {
        const brandSelect = document.getElementById('brand');
        const customBrand = document.getElementById('custom-brand');
        const chipsetSelect = document.getElementById('chipset');
        const customChipset = document.getElementById('custom-chipset');
        
        if (brandSelect.value === 'other' && customBrand.value.trim()) {
            brandSelect.value = customBrand.value.trim();
        }
        
        if (chipsetSelect.value === 'other' && customChipset.value.trim()) {
            chipsetSelect.value = customChipset.value.trim();
        }
    });
});
</script>

<?php include 'includes/footer.php'; ?>
